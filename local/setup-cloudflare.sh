#!/bin/bash

# Mikrus Toolbox - Cloudflare Setup
# Konfiguruje dostÄ™p do API Cloudflare (lokalnie).
# Pozwala na automatyczne dodawanie rekordÃ³w DNS.
# Author: PaweÅ‚ (Lazy Engineer)

set -e

CONFIG_DIR="$HOME/.config/cloudflare"
CONFIG_FILE="$CONFIG_DIR/config"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  â˜ï¸  Cloudflare DNS Setup                                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Ten skrypt skonfiguruje dostÄ™p do Cloudflare API."
echo "BÄ™dziesz mÃ³gÅ‚ automatycznie dodawaÄ‡ rekordy DNS dla swoich aplikacji."
echo ""

# 1. SprawdÅº czy juÅ¼ skonfigurowane
if [ -f "$CONFIG_FILE" ]; then
    echo "âš ï¸  Znaleziono istniejÄ…cÄ… konfiguracjÄ™: $CONFIG_FILE"
    read -p "NadpisaÄ‡? (t/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[TtYy]$ ]]; then
        echo "Anulowano."
        exit 0
    fi
fi

# 2. OtwÃ³rz przeglÄ…darkÄ™ z instrukcjami
echo "ðŸ“‹ Otwieram stronÄ™ Cloudflare do utworzenia tokenu..."
echo ""
echo "   W przeglÄ…darce:"
echo "   1. Kliknij 'Create Token'"
echo "   2. Kliknij 'Create Custom Token' (na dole)"
echo "   3. Dodaj uprawnienia:"
echo "      â€¢ Zone â†’ DNS â†’ Edit           (wymagane - rekordy DNS)"
echo "      â€¢ Zone â†’ Zone Settings â†’ Edit (opcjonalne - SSL, kompresja)"
echo "      â€¢ Zone â†’ Cache Rules â†’ Edit   (opcjonalne - cache Next.js)"
echo "   4. W 'Zone Resources' wybierz 'All zones' lub konkretne domeny"
echo "   5. Kliknij 'Continue to summary' â†’ 'Create Token'"
echo "   6. Skopiuj token (pokazuje siÄ™ tylko raz!)"
echo ""
echo "   ðŸ’¡ Uprawnienia Zone Settings i Cache Rules sÄ… potrzebne dla"
echo "      automatycznej optymalizacji (SSL Flexible, Brotli, cache)."
echo ""

# OtwÃ³rz przeglÄ…darkÄ™ (rÃ³Å¼ne komendy dla rÃ³Å¼nych systemÃ³w)
URL="https://dash.cloudflare.com/profile/api-tokens"
if command -v open &> /dev/null; then
    open "$URL"  # macOS
elif command -v xdg-open &> /dev/null; then
    xdg-open "$URL"  # Linux
elif command -v start &> /dev/null; then
    start "$URL"  # Windows (Git Bash)
else
    echo "   OtwÃ³rz rÄ™cznie: $URL"
fi

read -p "NaciÅ›nij Enter gdy skopiujesz token..."

echo ""
read -s -p "ðŸ”‘ Wklej API Token: " API_TOKEN
echo ""

if [ -z "$API_TOKEN" ]; then
    echo "âŒ Token nie moÅ¼e byÄ‡ pusty!"
    exit 1
fi

# 3. Weryfikacja tokenu
echo ""
echo "WeryfikujÄ™ token..."

VERIFY_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
    -H "Authorization: Bearer $API_TOKEN" \
    -H "Content-Type: application/json")

if echo "$VERIFY_RESPONSE" | grep -q '"success":true'; then
    echo "âœ… Token dziaÅ‚a!"
else
    echo "âŒ Token nieprawidÅ‚owy lub nie ma uprawnieÅ„!"
    echo "   OdpowiedÅº: $VERIFY_RESPONSE"
    exit 1
fi

# 4. Pobierz listÄ™ Zone IDs
echo ""
echo "Pobieram listÄ™ domen..."

ZONES_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones" \
    -H "Authorization: Bearer $API_TOKEN" \
    -H "Content-Type: application/json")

# Parsuj domeny â€” wyciÄ…gnij pary (id, name) z tablicy result[]
# jq jest preferowane, fallback na grep z parsowaniem per-obiekt
ZONE_PAIRS=""
if command -v jq &>/dev/null; then
    ZONE_PAIRS=$(echo "$ZONES_RESPONSE" | jq -r '.result[] | "\(.name)=\(.id)"' 2>/dev/null)
else
    # Fallback: wyciÄ…gnij obiekty z result array i parsuj id+name per obiekt
    # KaÅ¼dy zone obiekt ma "id" i "name" na poczÄ…tku â€” bierzemy je parami
    ZONE_PAIRS=$(echo "$ZONES_RESPONSE" \
        | tr '{' '\n' \
        | grep '"name"' \
        | while IFS= read -r obj; do
            local_id=$(echo "$obj" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')
            local_name=$(echo "$obj" | grep -o '"name":"[^"]*"' | head -1 | sed 's/"name":"//;s/"//')
            # Filtruj: prawdziwa domena musi mieÄ‡ kropkÄ™, bez spacji
            if [ -n "$local_id" ] && [ -n "$local_name" ] && [[ "$local_name" == *.* ]] && [[ "$local_name" != *" "* ]]; then
                echo "${local_name}=${local_id}"
            fi
        done)
fi

if [ -z "$ZONE_PAIRS" ]; then
    echo "âŒ Nie znaleziono Å¼adnych domen!"
    echo "   Upewnij siÄ™ Å¼e token ma dostÄ™p do przynajmniej jednej domeny."
    exit 1
fi

echo ""
echo "Znalezione domeny:"
echo "$ZONE_PAIRS" | cut -d= -f1 | nl
echo ""

# 5. Zapisz konfiguracjÄ™
mkdir -p "$CONFIG_DIR"
chmod 700 "$CONFIG_DIR"

cat > "$CONFIG_FILE" << EOF
# Cloudflare API Configuration
# Generated by Mikrus Toolbox

API_TOKEN=$API_TOKEN

# Zone mappings (domain=zone_id)
EOF

# Zapisz pary domain=zone_id
echo "$ZONE_PAIRS" >> "$CONFIG_FILE"

chmod 600 "$CONFIG_FILE"

echo ""
echo "âœ… Konfiguracja zapisana: $CONFIG_FILE"
echo ""
echo "ðŸš€ Teraz moÅ¼esz uÅ¼ywaÄ‡:"
echo "   ./local/dns-add.sh subdomena.twojadomena.pl IP_SERWERA"
echo ""
echo "   PrzykÅ‚ad:"
echo "   ./local/dns-add.sh status.mojafirma.pl 185.181.10.50"
echo ""
